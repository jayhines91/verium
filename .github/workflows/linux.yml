name: Build Verium (Linux)
  
on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: verium-ci-${{ github.ref }}   
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  HOST_TRIPLET: x86_64-pc-linux-gnu

jobs:
  linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Base deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential automake libtool pkg-config python3 \
            curl zip unzip ccache

      # Optional: preseed source tarballs (uncomment if you host them)
      # - name: Preseed depends sources
      #   run: |
      #     mkdir -p depends/sources
      #     gh release download deps-sources-v1 --pattern 'depends-sources-*.zip' --dir .
      #     unzip -o depends-sources-*.zip -d depends/sources
      #   env: { GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} }

      - name: Cache depends
        uses: actions/cache@v4
        with:
          path: |
            depends/sources
            depends/built
          key: linux-${{ env.HOST_TRIPLET }}-${{ hashFiles('depends/packages/*.mk') }}
          restore-keys: linux-${{ env.HOST_TRIPLET }}-

      - name: Build depends
        run: make -C depends HOST=${HOST_TRIPLET} -j"$(nproc || echo 2)"

      - name: Configure
        run: |
          ./autogen.sh
          export CONFIG_SITE="$(pwd)/depends/${HOST_TRIPLET}/share/config.site"
          set -o pipefail
          ./configure \
            --prefix="$(pwd)/depends/${HOST_TRIPLET}" \
            --host="${HOST_TRIPLET}" \
            --disable-bench --disable-tests \
            --enable-reduce-exports \
            --disable-shared --enable-static \
          || { echo "=== config.log (tail) ==="; tail -n 200 config.log || true; exit 1; }

      - name: Build
        run: make -j"$(nproc || echo 2)" V=1

      - name: Package + checksums
        run: |
          set -euo pipefail
          V="${{ github.ref_type == 'tag' && github.ref_name || '' }}"
          if [ -z "$V" ]; then V=$(git describe --tags --dirty --always || echo untagged); fi
          PKG="verium-${V}-${HOST_TRIPLET}.tar.gz"
          mkdir -p out
          cp -f src/veriumd* out/ 2>/dev/null || true
          cp -f src/verium-cli* out/ 2>/dev/null || true
          cp -f src/verium-tx* out/ 2>/dev/null || true
          cp -f src/qt/verium-qt* out/ 2>/dev/null || true
          [ -n "$(ls -A out)" ] || { echo "No binaries in out/"; exit 2; }
          tar -czf "$PKG" -C out .
          sha256sum "$PKG" > "${PKG}.SHA256SUMS"
          echo "ART_MAIN=$PKG" >> $GITHUB_ENV
          echo "ART_SUMS=${PKG}.SHA256SUMS" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: linux-${{ env.HOST_TRIPLET }}
          path: |
            ${{ env.ART_MAIN }}
            ${{ env.ART_SUMS }}
